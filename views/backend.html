<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="backend for exhibition website">
    <title>backend panel</title>
    <link id="favicon" rel="icon" href="https://cdn.glitch.com/05eaa61e-b555-434a-9ed1-1f00bdcd2e32%2Ffavicon.png?v=1618028934476" type="image/png">
    <link rel="stylesheet" href="/backend.css">
    <script src="/backend.js" defer></script>
<!--     <script src="/socket.io/socket.io.js"></script> -->
    <script src="https://all-at-once.glitch.me/socket.io/socket.io.js"></script>

    <script>
      var socket = io('https://all-at-once.glitch.me/')
      
      // get table structure: i = cam, j = color
      const table = [
        ["cam_01", "red", "blue"],
        ["cam_02", "red", "yellow", "blue"],
        ["cam_03", "red", "yellow", "blue"],
        ["cam_04", "red", "blue"],
        ["cam_05", "red", "blue"],
        ["cam_06", "red", "blue"],
        ["cam_07", "red", "blue"]
      ]
      
      // set table structure: i = cam, j = color
      let nameArray = [
        ["cam_01", ["red"], ["blue"]],
        ["cam_02", ["red"], ["yellow"], ["blue"]],
        ["cam_03", ["red"], ["yellow"], ["blue"]],
        ["cam_04", ["red"], ["blue"]],
        ["cam_05", ["red"], ["blue"]],
        ["cam_06", ["red"], ["blue"]],
        ["cam_07", ["red"], ["blue"]]
      ]
      
      // get all the names for each cam & color
      function getNameList(item,table,nameArray) {
        // loop through each cam
        for (let i = 0; i < table.length; i++) {
          if (item.meta.camera === table[i][0]) {
            // loop through each color
            for (let j = 1; j < table[i].length; j++) {
              if (item.meta.color === table[i][j]){
                nameArray[i][j].push(`
                  <div class="name ${item.status}">
                    <span>${item.meta.student}(${item.meta.duration})</span>
                    <form action="/cancel" method="post" class="button"><button type="submit" value=${item.filename} name="id">cancel</button></form>
                  </div>
                `)
              }
            }
          }
        }
      }
      
      function writeNameList(array, className) {
        let current = ''
        let queue = ''
        // for each row of the table
        if (array.length > 1) {
          current = `${array[1]}`
          for(let i = 2; i < array.length; i++) {
            queue += `${array[i]}`
          }
        }
        let slot = document.getElementsByClassName(className)[0].parentNode
        slot.nextElementSibling.innerHTML = current
        slot.nextElementSibling.nextElementSibling.innerHTML = queue
      }
            
      // write name list to the table
      function writeTable(nameArray, table) {
        // loop through each cam
        for (let i = 0; i < nameArray.length; i++) {
          // loop through each color
          for (let j = 1; j < nameArray[i].length; j++) {
            writeNameList(nameArray[i][j], `${table[i][0]} ${table[i][j]}`)
          }
        }
      }
      
      // set dropbox upload links for each folder
      const uploadLinks = {
        cam_01_red:    "https://www.dropbox.com/request/dpDwSFYoKliV1xJwkyit",
        cam_01_blue:   "https://www.dropbox.com/request/R7U1bl6rmvdJvTO2Vmmj",
        
        cam_02_red:    "https://www.dropbox.com/request/gCrgoC6ThnmrEx6DpNE1",
        cam_02_yellow: "https://www.dropbox.com/request/9bFxs7bqnV1f6XM9W8uI",
        cam_02_blue:   "https://www.dropbox.com/request/pCnYSPh3rW35fr3pNaHA",
        
        cam_03_red:    "https://www.dropbox.com/request/ehVBrBEgVzYy4kyGH95Y",
        cam_03_yellow: "https://www.dropbox.com/request/HXC74F67xvn8cgiQNnzr",
        cam_03_blue:   "https://www.dropbox.com/request/QdRVa6WK7s3ZMop8EXIK",
        
        cam_04_red:    "https://www.dropbox.com/request/UA62xBZHSl3qeUIwnKZn",
        cam_04_blue:   "https://www.dropbox.com/request/4vHXasBI1c3LCYzli1pa",
        
        cam_05_red:    "https://www.dropbox.com/request/BZeXL96f0D9nTswxShb7",
        cam_05_blue:   "https://www.dropbox.com/request/jffm34NUdWqPly3mKWbX",
        
        cam_06_red:    "https://www.dropbox.com/request/Bjbbz402r93eZXfex2a2",
        cam_06_blue:   "https://www.dropbox.com/request/VVNW6HAvB7SeqhatJ2i2",
        
        cam_07_red:    "https://www.dropbox.com/request/POtkB7ZEdnSGl1Ig0SoP",
        cam_07_blue:   "https://www.dropbox.com/request/bppUc7KapIQ5mVPX0C28"
      }
      
      // add a confirm message when clicking the cancel button
      function addCancelEvent() {
        let cancelButtons = document.querySelectorAll('form.button')
        for ( let cancelButton of cancelButtons ) {
          // console.log(cancelButton.firstElementChild.value)
          cancelButton.addEventListener('submit', (e) => {
            e.preventDefault()
            let confirm = window.confirm('Are you sure you want to cancel this stream?')
            if (confirm) {
              let cancelledItem = cancelButton.firstElementChild.value
              socket.emit('cancel', cancelledItem)
            }
          })
        }
      }
      
      
      
      window.onload = async () => {
        // get form data
        let form = document.querySelector("#form")
        let student = document.querySelector("#students")
        let camera = document.querySelector("#cameras")
        let color = document.querySelector("#colors")
        let title = document.querySelector("#title")
        let caption = document.querySelector("#caption")
        let duration = document.querySelector("#duration")
        
        // send form meta on submission
        form.addEventListener('submit', (e)=>{
          e.preventDefault()
          let meta = {
            "uploadTimestamp": Date.now(),
            "student": students.value,
            "camera": camera.value,
            "color": color.value,
            "title": title.value,
            "caption": caption.value,
            "duration": duration.value
          }
          socket.emit('new submission', meta) 
        })
        
        
        // generate a filename after submission
        socket.on('generate filename', (submittedItem)=>{
          // add a success message
          document.querySelector('#success').innerHTML = 'success!'
          // get filename
          document.querySelector('#filename').innerHTML = submittedItem.filename
          document.querySelector('#filename').className = submittedItem.meta.color + "-border"
          // get dropbox file upload link
          let folder =  submittedItem.meta.camera + "_" + submittedItem.meta.color
          document.querySelector('#upload-button').href = uploadLinks[folder]
          document.querySelector('#upload-button button').style.cursor = "pointer"          
        })
        
        
        // refresh the queue after submission
        socket.on('refresh data', (queue)=>{
          //reset nameArray
          nameArray = [
            ["cam_01", ["red"], ["blue"]],
            ["cam_02", ["red"], ["yellow"], ["blue"]],
            ["cam_03", ["red"], ["yellow"], ["blue"]],
            ["cam_04", ["red"], ["blue"]],
            ["cam_05", ["red"], ["blue"]],
            ["cam_06", ["red"], ["blue"]],
            ["cam_07", ["red"], ["blue"]]
          ]
          
          // get names for each cam & color, write name list to the table
          for(let item of queue) { getNameList(item,table,nameArray) }
          writeTable(nameArray, table)
          
          // show cancel button on hover
          let names = document.getElementsByClassName('name active')
          for ( let name of names ) {
            name.addEventListener('mouseenter', () => {
              name.firstElementChild.style.color = "transparent"
              name.lastElementChild.style.display = "inline"
            })
            name.addEventListener('mouseleave', () => {
              name.firstElementChild.style.color = "black"
              name.lastElementChild.style.display = "none"
            })
          }
          
          // confirm to cancel 
          addCancelEvent()
        })

      }
    </script>
  </head>
  <body>
    <div id="container">
      <div id="left">
        YGDMFAâ€™21 EXHIBITION
        <p><em>queue it up!</em></p>
        <hr>
        <form action="/submit" method="post" enctype="multipart/form-data" id="form">
          <label for="students">Your name:</label>
          <select name="students" id="students">
            <option value="Herdimas">Herdimas</option>
            <option value="Milo">Milo</option>
            <option value="Bianca">Bianca</option>
            <option value="Furqan">Furqan</option>
            <option value="Harin">Harin</option>
            <option value="Jun">Jun</option>
            <option value="Minhwan">Minhwan</option>
            <option value="Nick">Nick</option>
            <option value="Anezka">Anezka</option>
            <option value="Luiza">Luiza</option>
            <option value="Ana">Ana</option>
            <option value="Mengyi">Mengyi</option>
            <option value="Anna">Anna</option>
            <option value="Mianwei">Mianwei</option>
          </select>
          <br><br>

          <label for="cameras">Camera:</label>
          <select name="cameras" id="cameras">
            <option value="cam_01">cam_01</option>
            <option value="cam_02">cam_02</option>
            <option value="cam_03">cam_03</option>
            <option value="cam_04">cam_04</option>
            <option value="cam_05">cam_05</option>
            <option value="cam_06">cam_06</option>
            <option value="cam_07">cam_07</option>
          </select>
          <br><br>

          <label for="colors">Color:</label>
          <select name="colors" id="colors">
            <option value="red">red</option>
            <option value="yellow">yellow</option>
            <option value="blue">blue</option>
          </select>
          <br><br>

          <label for="title">Title:</label>
          <input type="text" id="title" name="title" placeholder="title"><br><br>
          <label for="caption">Caption:</label>
          <textarea id="caption" name="caption" rows="3"></textarea>
          <br><br><br><br>


          <label for="duration">Duration:</label>
          <select name="duration" id="duration">
            <option value="5m">loop / 5min</option>
            <option value="15m">loop / 15min</option>
            <option value="30m">loop / 30min</option>
            <option value="1h">loop / 1hr</option>
            <option value="2h">loop / 2hr</option>
            <option value="3h">loop / 3hr</option>
            <option value="4h">loop / 4hr</option>
            <option value="5h">loop / 5hr</option>
            <option value="6h">loop / 6hr</option>
          </select>

          <br><br>
          
          <input type="submit" value="add to queue" id="submit">
          <span id="success"></span>
        </form>
        
        <br><br>
        <hr>
        
        <label>Please rename your filename as:</label>
        <a target="_blank" id="upload-button">
          <button>upload</button>
        </a>
        <br><br>
        <label><span id="filename"></span></label>
        
      </div>

      <div id="right">
        <strong>Queue</strong> <em>(live, automatic updates)</em><br><br>
        <table>
          <colgroup>
            <col span="1" style="width:115px">
            <col span="1" style="width:25px">
            <col span="1" style="width:110px">
            <col span="1" style="width:300px">
          </colgroup>
          <tr>
            <th></th>
            <th></th>
            <th>current</th>
            <th>queue</th>
          </tr>
          <tr>
            <td>cam_01 (image)</td>
            <td><div class="color cam_01 red"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_01 blue"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>cam_02 (image)</td>
            <td><div class="color cam_02 red"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_02 yellow"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_02 blue"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>cam_03 (image)</td>
            <td><div class="color cam_03 red"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_03 yellow"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_03 blue"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>cam_04 (image)</td>
            <td><div class="color cam_04 red"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_04 blue"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>cam_05 (video)</td>
            <td><div class="color cam_05 red"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_05 blue"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>cam_06 (image)</td>
            <td><div class="color cam_06 red"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_06 blue"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>cam_07 (image)</td>
            <td><div class="color cam_07 red"></div></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td></td>
            <td><div class="color cam_07 blue"></div></td>
            <td></td>
            <td></td>
          </tr>
        </table>
      </div>
    </div>
    
  </body>
</html>
